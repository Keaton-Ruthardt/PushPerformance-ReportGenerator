# Push Performance App - Render Deployment Guide

Complete guide to deploying the Push Performance web application (React frontend + Node.js backend + PDF generator) to Render.

## What Gets Deployed

- **Frontend**: React app (Vite) - built to static files
- **Backend**: Node.js/Express API server
- **PDF Generator**: Puppeteer-based PDF generation service
- **Database**: PostgreSQL (optional - currently using BigQuery)
- **BigQuery**: Google Cloud BigQuery for athlete data and percentiles

## Prerequisites

1. GitHub account with your code pushed to a repository
2. Render account (https://render.com - free tier available)
3. Google Cloud credentials JSON file for BigQuery access
4. VALD API credentials

## Deployment Steps

### 1. Prepare Your Code

Make sure all changes are committed and pushed to GitHub:

```bash
cd "C:\Users\Jkeat\Push Performance\push-performance-app"

# Add all changes
git add .

# Commit
git commit -m "Prepare for Render deployment"

# Push to GitHub
git push origin main
```

### 2. Create Render Services

#### Option A: Using Render Blueprint (Recommended)

1. Go to https://dashboard.render.com
2. Click "New +" → "Blueprint"
3. Connect your GitHub repository
4. Render will auto-detect `render.yaml` and create all services

#### Option B: Manual Setup

1. Go to https://dashboard.render.com
2. Click "New +" → "Web Service"
3. Connect your GitHub repository
4. Configure as follows:

**Build Settings:**
- **Name**: `push-performance-api`
- **Region**: Oregon (or closest to you)
- **Branch**: `main`
- **Root Directory**: Leave blank (or specify if in subdirectory)
- **Runtime**: Node
- **Build Command**: `npm install && cd client && npm install && npm run build && cd ..`
- **Start Command**: `npm run server`

**Plan:**
- Start with **Free** tier for testing
- Upgrade to **Starter** ($7/month) for production use

### 3. Configure Environment Variables

In Render dashboard, go to your web service → "Environment" tab and add these variables:

#### Required Variables

```bash
# Node Environment
NODE_ENV=production
PORT=5000

# JWT Secret (auto-generated by Render)
JWT_SECRET=<auto-generated>

# Trainer Login
TRAINER_USERNAME=pushtrainer
TRAINER_PASSWORD=<your-secure-password>

# VALD API Configuration
VALD_CLIENT_ID=<your-vald-client-id>
VALD_CLIENT_SECRET=<your-vald-client-secret>
VALD_USERNAME=<your-vald-username>
VALD_PASSWORD=<your-vald-password>
VALD_PRIMARY_API=https://cloud.valdperformance.com/api/v3.3
VALD_SECONDARY_API=https://valdperformance.com/api/v3.3
VALD_PRIMARY_TOKEN=<your-primary-token>
VALD_SECONDARY_TOKEN=<your-secondary-token>

# BigQuery Configuration
BIGQUERY_PROJECT_ID=vald-ref-data-copy
BIGQUERY_DATASET=VALDrefDataCOPY
GOOGLE_APPLICATION_CREDENTIALS=/etc/secrets/bigquery-credentials.json

# Percentile Sync Schedule
PERCENTILE_SYNC_SCHEDULE=0 3 * * *

# Puppeteer Configuration
PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=false
PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
```

#### Optional Database Variables (if using PostgreSQL)

```bash
DB_HOST=<from-render-database>
DB_PORT=<from-render-database>
DB_NAME=push_performance
DB_USER=<from-render-database>
DB_PASSWORD=<from-render-database>
```

### 4. Upload BigQuery Credentials

1. In Render dashboard, go to your web service
2. Click "Environment" tab
3. Scroll to "Secret Files" section
4. Click "Add Secret File"
5. Configure:
   - **Filename**: `/etc/secrets/bigquery-credentials.json`
   - **Contents**: Paste the entire contents of your `vald-ref-data-copy-0c0792ad4944.json` file

### 5. Add Disk for Puppeteer (PDF Generation)

Puppeteer needs disk space for caching Chromium:

1. In Render dashboard, go to your web service
2. Click "Disks" tab
3. Click "Add Disk"
4. Configure:
   - **Name**: `puppeteer-cache`
   - **Mount Path**: `/opt/render/.cache`
   - **Size**: 1 GB

### 6. Deploy

1. Click "Manual Deploy" → "Deploy latest commit"
2. Monitor the build logs
3. Wait for deployment to complete (5-10 minutes)

### 7. Verify Deployment

Once deployed, test your application:

1. **Health Check**:
   ```bash
   curl https://your-app-name.onrender.com/health
   ```

   Should return:
   ```json
   {"status":"ok","message":"Push Performance API is running"}
   ```

2. **Frontend**:
   - Visit `https://your-app-name.onrender.com` in browser
   - Should see the React app login page

3. **Test Login**:
   - Username: `pushtrainer`
   - Password: (the one you set)

4. **Test Report Generation**:
   - Search for an athlete
   - Generate a report
   - Verify PDF download works

## Troubleshooting

### Build Fails

**Error**: `npm install` fails

**Solution**: Check package.json for any invalid dependencies. Try building locally first:
```bash
npm install && cd client && npm install && npm run build
```

### Puppeteer/PDF Generation Fails

**Error**: "Could not find Chrome/Chromium"

**Solution**: Ensure these environment variables are set:
```bash
PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=false
PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
```

Also ensure the Disk is mounted at `/opt/render/.cache`.

### BigQuery Connection Fails

**Error**: "Could not authenticate with BigQuery"

**Solutions**:
1. Verify the secret file is uploaded correctly
2. Check `GOOGLE_APPLICATION_CREDENTIALS` points to `/etc/secrets/bigquery-credentials.json`
3. Ensure the JSON file content is valid
4. Verify the service account has BigQuery permissions

### VALD API Fails

**Error**: "VALD API authentication failed"

**Solutions**:
1. Verify all VALD credentials are set correctly
2. Test credentials locally first
3. Check that tokens haven't expired
4. Ensure `VALD_CLIENT_ID`, `VALD_CLIENT_SECRET`, `VALD_USERNAME`, `VALD_PASSWORD` are all set

### App Crashes on Startup

**Error**: Service keeps restarting

**Solutions**:
1. Check logs in Render dashboard → "Logs" tab
2. Look for missing environment variables
3. Verify all required secrets are set
4. Test the start command locally:
   ```bash
   NODE_ENV=production npm run server
   ```

### 404 on React Routes

**Error**: Routes like `/dashboard` return 404

**Solution**: The server is correctly configured to serve React app. If this happens:
1. Check that the build completed successfully
2. Verify `client/dist` folder exists after build
3. Ensure `NODE_ENV=production` is set

## Monitoring

### View Logs

In Render dashboard:
1. Go to your web service
2. Click "Logs" tab
3. See real-time logs from your application

### Metrics

Render provides:
- CPU usage
- Memory usage
- Request count
- Response times

Access these in the "Metrics" tab.

### Alerts

Set up alerts for:
- Service downtime
- High error rates
- Memory/CPU limits

## Costs

### Free Tier
- 750 hours/month of free services
- Services spin down after 15 minutes of inactivity
- **Good for**: Testing, development

### Starter Tier ($7/month)
- Always-on (no spin down)
- More resources
- **Good for**: Production use

### Additional Costs
- PostgreSQL database: $7/month (Starter plan) - optional
- Disk storage: Included in plan
- Outbound bandwidth: 100GB/month included

**Total Estimated Cost**: $7-14/month

## Updating the App

When you make changes:

1. Commit and push to GitHub:
   ```bash
   git add .
   git commit -m "Update description"
   git push
   ```

2. Render will **auto-deploy** on every push to main branch

3. Or manually deploy in Render dashboard:
   - Click "Manual Deploy" → "Deploy latest commit"

## Environment Variable Reference

### Critical (Required)

| Variable | Description | Example |
|----------|-------------|---------|
| `NODE_ENV` | Node environment | `production` |
| `JWT_SECRET` | JWT signing secret | Auto-generated |
| `TRAINER_PASSWORD` | Login password | `SecurePass123!` |
| `VALD_CLIENT_ID` | VALD API client ID | `abc123...` |
| `VALD_CLIENT_SECRET` | VALD API client secret | `xyz789...` |
| `VALD_USERNAME` | VALD API username | `your@email.com` |
| `VALD_PASSWORD` | VALD API password | `yourpassword` |
| `GOOGLE_APPLICATION_CREDENTIALS` | BigQuery credentials path | `/etc/secrets/bigquery-credentials.json` |

### Optional

| Variable | Description | Default |
|----------|-------------|---------|
| `PORT` | Server port | `5000` |
| `PERCENTILE_SYNC_SCHEDULE` | Cron schedule for percentile sync | `0 3 * * *` |
| `PUPPETEER_EXECUTABLE_PATH` | Chromium path | `/usr/bin/chromium-browser` |

## Custom Domain (Optional)

To use your own domain:

1. In Render dashboard, go to "Settings"
2. Scroll to "Custom Domain"
3. Click "Add Custom Domain"
4. Follow DNS configuration instructions
5. Add CNAME record: `your-domain.com` → `your-app.onrender.com`

## Backup and Data

- **BigQuery**: Data is stored in Google Cloud (already backed up)
- **PostgreSQL**: Render provides automatic daily backups (if using)
- **Application code**: Backed up in GitHub

## Security Checklist

Before going live:

- [ ] All environment variables set as "secrets" (not visible in logs)
- [ ] Strong `TRAINER_PASSWORD` set
- [ ] `JWT_SECRET` is auto-generated (secure)
- [ ] BigQuery credentials file uploaded securely
- [ ] VALD API credentials verified
- [ ] HTTPS is enabled (automatic on Render)
- [ ] No sensitive data in code or logs

## Support

### Render Support
- Documentation: https://render.com/docs
- Community: https://community.render.com
- Status: https://status.render.com

### Application Issues
- Check logs in Render dashboard
- Test locally with production environment variables
- Review error messages and stack traces

## Next Steps After Deployment

1. **Test thoroughly**: Try all features in production
2. **Monitor logs**: Watch for errors or warnings
3. **Set up alerts**: Configure Render to notify you of issues
4. **Optimize performance**: Monitor metrics and adjust as needed
5. **Plan for scale**: Upgrade plan if needed based on usage

## Rolling Back

If something goes wrong:

1. In Render dashboard, go to "Events" tab
2. Find a previous successful deployment
3. Click "Rollback to this deploy"
4. Service will redeploy with previous code

## Additional Resources

- [Render Node.js Deployment Guide](https://render.com/docs/deploy-node-express-app)
- [Render Environment Variables](https://render.com/docs/environment-variables)
- [Render Disks](https://render.com/docs/disks)
- [Puppeteer on Render](https://render.com/docs/puppeteer)
